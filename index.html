<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Calculadora AV: Snellen → logMAR / ETDRS</title>
  <style>
    :root{
      --ok:#2e7d32; --mid:#455a64; --bad:#c62828;
      --bg:#0b0e12; --fg:#e7edf3; --card:#141a22; --muted:#9fb0bf;
      --shadow: 0 6px 18px rgba(0,0,0,.25); --radius: 16px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.45 system-ui, sans-serif}
    .container{max-width:900px;margin:32px auto;padding:0 16px}
    h1{font-size:1.6rem;margin:0 0 8px}
    .subtitle{color:var(--muted);margin:0 0 20px}
    .card{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);margin:16px 0;border:1px solid rgba(255,255,255,.05)}
    legend{padding:0 6px;color:var(--muted)}
    label{display:block;font-weight:600;margin-bottom:8px}
    input[type=text],input[type=number]{width:100%;padding:10px 12px;border-radius:12px;border:1px solid #29313b;background:#0e141b;color:var(--fg)}
    input:invalid{border-color:#7c3aed}
    .row{display:flex;flex-wrap:wrap;gap:14px;align-items:center}
    .radio{display:flex;gap:6px;align-items:center;font-weight:500}
    .numwrap{display:flex;align-items:center;gap:8px}
    .grid{display:grid;gap:16px}
    .grid-3{grid-template-columns:repeat(auto-fit,minmax(180px,1fr))}
    @media(min-width:680px){.grid{grid-template-columns:1fr 1fr}}
    .actions{display:flex;gap:10px;margin-top:12px}
    button{border:0;padding:10px 14px;border-radius:12px;cursor:pointer;font-weight:700;background:linear-gradient(180deg,#3b82f6,#2563eb);color:white}
    button[disabled]{opacity:.4;cursor:not-allowed}
    button.ghost{background:#223041;color:#cfe1f8}
    #msg{min-height:1.2em;color:#fbbf24;font-weight:600}
    .bars{display:grid;gap:14px;margin:8px 0 4px}
    .bar-label{font-size:.9rem;color:var(--muted);margin-bottom:4px}
    .bar-track{height:18px;background:#0e141b;border-radius:999px;border:1px solid #263140;overflow:hidden}
    .bar-fill{height:100%;width:0%;background:var(--mid);transition:width .3s ease, background-color .2s ease}
    .bar-text{font-size:.9rem;color:#b7c7d6;margin-top:4px}
    .metric{background:#0f1620;padding:12px;border-radius:12px;border:1px solid #1f2a36}
    .metric .k{color:#9fb0bf;font-size:.85rem}
    .metric .v{font-size:1.2rem;font-weight:800}
    .kv{list-style:none;padding:0;margin:8px 0 0}
    .kv li{display:flex;justify-content:space-between;gap:10px;padding:6px 0;border-bottom:1px dashed #283244}
    .kv li:last-child{border-bottom:0}
    .kv .k{color:#9fb0bf}
    .kv .v{font-weight:700}
    .chip{display:inline-block;padding:8px 12px;border-radius:999px;font-weight:800;margin-top:10px}
    .ok{color:#b7f2c2;background:rgba(46,125,50,.12)}
    .bad{color:#ffc6c6;background:rgba(198,40,40,.1)}
    .neutral{color:#cfe1f8;background:rgba(69,90,100,.15)}
    .disclaimer{margin-top:10px;color:#90a4b4}
    .help{font-size:.85rem;color:#9fb0bf;margin-top:6px}
    .patient{margin-top:10px;color:#cfe1f8}
  </style>
</head>
<body>
  <main class="container">
    <h1>Calculadora de Agudeza Visual</h1>
    <p class="subtitle">Entrada en <strong>Snellen</strong> o categorías de baja visión (<strong>CF</strong>, <strong>HM</strong>, <strong>PL</strong>, <strong>NPL</strong>). Conversión a <strong>logMAR</strong> y <strong>ETDRS (letras)</strong>. Además se muestra la <strong>reducción porcentual del déficit visual en logMAR</strong>.</p>

    <form id="av-form" novalidate>
      <fieldset class="card">
        <legend>Configuración de Snellen</legend>
        <div class="row" id="modeRow">
          <label class="radio"><input type="radio" name="mode" value="20" checked />20/x (pies)</label>
          <label class="radio"><input type="radio" name="mode" value="6" />6/x (metros)</label>
          <label class="radio"><input type="radio" name="mode" value="custom" />Personalizado</label>
          <label class="numwrap" id="custom-num-wrap" hidden>Numerador:&nbsp;<input id="customNumerator" type="number" min="1" max="100" step="1" value="10" /></label>
        </div>
      </fieldset>

      <fieldset class="card">
        <legend>Entradas</legend>
        <div class="grid">
          <label>AV inicial (Snellen o CF/HM/PL/NPL)
            <input id="snellenInitial" type="text" placeholder="20/150, 0.13, CF, HM, PL o NPL" required />
          </label>
          <label>AV actual (Snellen o CF/HM/PL/NPL)
            <input id="snellenCurrent" type="text" placeholder="20/80, 0.25, CF, HM, PL o NPL" required />
          </label>
        </div>
        <div class="help">Atajos aceptados: <strong>CF</strong>=Cuenta dedos, <strong>HM</strong>=Movimiento de manos (MM), <strong>PL</strong>=Percepción de luz (LP), <strong>NPL</strong>=Sin PL.</div>
        <div class="actions">
          <button id="calcBtn" type="submit" disabled>Calcular</button>
          <button id="clearBtn" type="button" class="ghost">Limpiar</button>
        </div>
        <p id="msg"></p>
      </fieldset>
    </form>

    <section id="results" class="card" hidden>
      <h2>Resultados</h2>
      <div class="bars">
        <div class="bar">
          <div class="bar-label">AV inicial</div>
          <div class="bar-track"><div id="barInitial" class="bar-fill"></div></div>
          <div id="barInitialText" class="bar-text"></div>
        </div>
        <div class="bar">
          <div class="bar-label">AV actual</div>
          <div class="bar-track"><div id="barCurrent" class="bar-fill"></div></div>
          <div id="barCurrentText" class="bar-text"></div>
        </div>
      </div>

      <div class="grid grid-3">
        <div class="metric"><div class="k">ΔETDRS</div><div id="deltaEtdrs" class="v"></div></div>
        <div class="metric"><div class="k">ΔlogMAR</div><div id="deltaLogmar" class="v"></div></div>
        <div class="metric"><div class="k">Reducción déficit (logMAR)</div><div id="deficitReduction" class="v"></div></div>
        <div class="metric"><div class="k">% ganancia real (→20/20)</div><div id="realGain" class="v"></div></div>
      </div>

      <div class="grid">
        <div>
          <h3>Visita inicial</h3>
          <ul id="initialList" class="kv"></ul>
        </div>
        <div>
          <h3>Visita actual</h3>
          <ul id="currentList" class="kv"></ul>
        </div>
      </div>

      <div class="chip" id="classification">—</div>
      <p class="patient" id="patientLine" hidden></p>

      <details class="disclaimer">
        <summary>Nota</summary>
        <p>Fórmulas estándar: logMAR = log<sub>10</sub>(denominador/numerador); ETDRS (letras) ≈ <strong>85 − 50·logMAR</strong>; 0.1 logMAR ≈ 5 letras (≈1 línea). La <strong>reducción de déficit visual</strong> se calcula en logMAR: (logMAR<sub>inicial</sub> − logMAR<sub>actual</sub>)/logMAR<sub>inicial</sub> × 100. Ejemplo: de 2.0 a 0.6 → 70% de reducción del déficit. Para CF/HM/PL/NPL se usan equivalencias psicofísicas aproximadas reportadas en la literatura.</p>
        <h4>Referencias</h4>
        <ol>
          <li>Gregori NZ, Feuer W, Rosenfeld PJ. Novel method for analyzing Snellen visual acuity measurements. <em>Ophthalmic Epidemiology</em>. 2010;17(6):256-260. (Fórmula letras ETDRS ≈ 85 + 50·log10(fracción Snellen) y, por tanto, 85 − 50·logMAR).</li>
          <li>Schulze-Bonsel K, Feltgen N, Burau H, Hansen L, Bach M. Visual acuities "hand motion" and "counting fingers" can be quantified with the Freiburg Visual Acuity Test. <em>Invest Ophthalmol Vis Sci</em>. 2006;47(3):1236–1240. (Cuantificación de CF/HM en logMAR).</li>
          <li>Lange C, Feltgen N, Junker B, Schulze-Bonsel K, Bach M. Resolving the clinical acuity categories "hand motion" and "counting fingers" using the Freiburg Visual Acuity Test (FrACT). <em>Graefes Arch Clin Exp Ophthalmol</em>. 2009;247(1):137–142. (Validación adicional de CF/HM).</li>
          <li>U.S. Department of Health and Human Services. <em>Systematic Review of the Effectiveness of Cataract Surgery in the Elderly</em>; Glosario. (1 línea ETDRS = 0.1 logMAR; 1 letra ≈ 0.02 logMAR).</li>
        </ol>
        <p class="help"><strong>Autoría:</strong> Calculadora creada por el Dr. <strong>Luis Daniel García Arzate</strong>, oftalmólogo con alta especialidad en <strong>retina y vítreo</strong>.</p>
      </details>
    </section>
  </main>

<script>
// ===== Mapas y utilidades =====
const LOW_VISION_MAP = {
  'CF':  { logMAR: 1.98, label: 'Cuenta dedos' },
  'CD':  { logMAR: 1.98, label: 'Cuenta dedos' },
  'HM':  { logMAR: 2.28, label: 'Movimiento de manos' },
  'MM':  { logMAR: 2.28, label: 'Movimiento de manos' },
  'PL':  { logMAR: 2.70, label: 'Percepción de luz' },
  'LP':  { logMAR: 2.70, label: 'Percepción de luz' },
  'NPL': { logMAR: 3.00, label: 'Sin percepción de luz' }
};

function parseSnellen(inputStr, mode, customNumerator){
  if(!inputStr) return null;
  const cleaned = String(inputStr).trim().replace(',', '.').toUpperCase();
  // Tokens de baja visión
  if(LOW_VISION_MAP[cleaned]){
    const m = mode==='20'?20:mode==='6'?6:Number(customNumerator)||10;
    const logm = LOW_VISION_MAP[cleaned].logMAR;
    const vaDec = Math.pow(10, -logm);
    const n = m / vaDec;
    return { m, n, vaDec, token: cleaned, tokenLabel: LOW_VISION_MAP[cleaned].label, approx: true, logmarForced: logm };
  }
  // Fracción o decimal
  let m = mode==='20'?20:mode==='6'?6:Number(customNumerator)||10;
  if(cleaned.includes('/')){
    const [a,b] = cleaned.split('/');
    const num = Number(a), den = Number(b);
    if(!isFinite(num)||!isFinite(den)||num<=0||den<=0) return null;
    return { m:num, n:den, vaDec: num/den };
  }
  const va = Number(cleaned);
  if(!isFinite(va)||va<=0) return null;
  const n = m/va;
  return { m, n, vaDec: m/n };
}
function toLogMAR(m,n){ return Math.log10(n/m); }
function toETDRS_raw(logmar){ return 85 - 50*logmar; }
function formatSnellen(m,n,mode,custom,token){
  if(token){ return token; }
  const va = m/n;
  const M = mode==='6'?6:mode==='custom'?Number(custom)||10:20;
  const denom = M/va;
  const rounded = Math.round(denom);
  return `${M}/${(rounded>9999)?'∞':rounded}`;
}
function classify(dE,dL){
  if(dE>=5 || dL<=-0.1) return {label:'MEJORA', cls:'ok'};
  if(dE<=-5 || dL>=0.1) return {label:'EMPEORA', cls:'bad'};
  return {label:'SIN CAMBIO', cls:'neutral'};
}
function pctRealGain(va0,va1){ 
  if(va0>=1 && va1>=1) return 0;
  return ((va1 - va0) / (1 - Math.min(0.999999, va0))) * 100;
}
function clamp(x,lo,hi){ return Math.max(lo, Math.min(hi, x)); }
function round(x,d=2){ return Number(Math.round(x*10**d)/10**d); }

// ===== DOM =====
const form=document.getElementById('av-form');
const inputs=[document.getElementById('snellenInitial'),document.getElementById('snellenCurrent')];
const calcBtn=document.getElementById('calcBtn');
const msg=document.getElementById('msg');
const results=document.getElementById('results');
const barInitial=document.getElementById('barInitial');
const barCurrent=document.getElementById('barCurrent');
const barInitialText=document.getElementById('barInitialText');
const barCurrentText=document.getElementById('barCurrentText');
const deltaEtdrsEl=document.getElementById('deltaEtdrs');
const deltaLogmarEl=document.getElementById('deltaLogmar');
const deficitReductionEl=document.getElementById('deficitReduction');
const realGainEl=document.getElementById('realGain');
const initialList=document.getElementById('initialList');
const currentList=document.getElementById('currentList');
const classificationChip=document.getElementById('classification');
const modeRow=document.getElementById('modeRow');
const customWrap=document.getElementById('custom-num-wrap');
const customNumerator=document.getElementById('customNumerator');
const patientLine=document.getElementById('patientLine');

function isValidInput(s){
  if(!s) return false;
  const t=String(s).trim();
  const T=t.toUpperCase();
  if(LOW_VISION_MAP[T]) return true;
  if(t.includes('/')){
    const[a,b]=t.split('/');
    return isFinite(a)&&isFinite(b)&&a>0&&b>0;
  }
  return isFinite(t)&&t>0;
}
function updateButton(){
  const ok=isValidInput(inputs[0].value)&&isValidInput(inputs[1].value);
  calcBtn.disabled=!ok;
  msg.textContent=ok?'':'Ingresa dos valores válidos';
}
inputs.forEach(i=>i.addEventListener('input',updateButton));

// Mostrar/ocultar numerador personalizado
modeRow.addEventListener('change', ()=>{
  const mode=document.querySelector('input[name="mode"]:checked').value;
  customWrap.hidden = mode!=='custom';
});

form.addEventListener('submit',e=>{
  e.preventDefault();
  const mode=document.querySelector('input[name="mode"]:checked').value;
  const custom=customNumerator.value;

  const p0=parseSnellen(inputs[0].value,mode,custom);
  const p1=parseSnellen(inputs[1].value,mode,custom);
  if(!p0||!p1){ msg.textContent='Formato inválido'; return; }

  const l0 = (p0.approx && isFinite(p0.logmarForced)) ? p0.logmarForced : toLogMAR(p0.m,p0.n);
  const l1 = (p1.approx && isFinite(p1.logmarForced)) ? p1.logmarForced : toLogMAR(p1.m,p1.n);

  // ETDRS con mínimo 0 (evita negativos)
  const e0_raw = toETDRS_raw(l0), e1_raw = toETDRS_raw(l1);
  const e0 = Math.max(0, e0_raw), e1 = Math.max(0, e1_raw);

  const dE = e1 - e0;
  const dL = l1 - l0;

  const va0 = p0.vaDec, va1 = p1.vaDec;
  const pctRG = pctRealGain(va0,va1);

  // Reducción del déficit en logMAR: (l0 - l1)/l0
  let deficitRedText = '—';
  if(l0>0){
    const deficitRed = ((l0 - l1) / l0) * 100;
    deficitRedText = `${round(deficitRed,1)}%`;
  }

  // Barras (0-100 letras)
  barInitial.style.width = `${clamp(e0,0,100)}%`;
  barCurrent.style.width = `${clamp(e1,0,100)}%`;
  const color = (dE>=5||dL<=-0.1) ? "var(--ok)" : (dE<=-5||dL>=0.1) ? "var(--bad)" : "var(--mid)";
  barInitial.style.backgroundColor = color;
  barCurrent.style.backgroundColor = color;

  // Textos
  barInitialText.textContent = `${formatSnellen(p0.m,p0.n,mode,custom,p0.token)} | logMAR ${round(l0,2)} | ${Math.round(e0)} letras`;
  barCurrentText.textContent = `${formatSnellen(p1.m,p1.n,mode,custom,p1.token)} | logMAR ${round(l1,2)} | ${Math.round(e1)} letras`;

  // Métricas
  deltaEtdrsEl.textContent = `${dE>=0?'+':''}${Math.round(dE)} letras`;
  deltaLogmarEl.textContent = `${dL>=0?'+':''}${round(dL,2)}`;
  deficitReductionEl.textContent = deficitRedText;
  realGainEl.textContent = `${round(pctRG,1)}%`;

  // Listas detalle
  const baseList = (p, l, e, e_raw) => {
    const M = formatSnellen(p.m,p.n,mode,custom,p.token);
    const approxNote = p.approx ? " (aprox.)" : "";
    const percVs20 = round(p.vaDec*100,1);
    const hadClamp = (Math.round(Math.max(0,e_raw))!==Math.round(e));
    const etdrsText = `${Math.round(e)} letras${approxNote}${hadClamp? ' (min 0)': ''}`;
    return `
      <li><span class='k'>Snellen</span><span class='v'>${M}</span></li>
      <li><span class='k'>VA decimal</span><span class='v'>${round(p.vaDec,3)} (${percVs20}%)</span></li>
      <li><span class='k'>logMAR</span><span class='v'>${round(l,2)}${approxNote}</span></li>
      <li><span class='k'>ETDRS</span><span class='v'>${etdrsText}</span></li>
      ${p.token?`<li><span class='k'>Categoría</span><span class='v'>${p.token} · ${p.tokenLabel}</span></li>`:''}
    `;
  };
  initialList.innerHTML = baseList(p0,l0,e0,e0_raw);
  currentList.innerHTML = baseList(p1,l1,e1,e1_raw);

  // Clasificación
  const cls = classify(dE,dL);
  classificationChip.textContent = `Clasificación: ${cls.label}`;
  classificationChip.className = `chip ${cls.cls}`;

  // Línea estilo paciente
  if(l0>0){
    const pctVal = ((l0 - l1) / l0) * 100;
    patientLine.textContent = `El paciente redujo un ${round(pctVal,0)}% su déficit visual en escala logMAR (de ${round(l0,2)} a ${round(l1,2)}).`;
    patientLine.hidden = false;
  }else{
    patientLine.textContent = '';
    patientLine.hidden = true;
  }

  results.hidden=false;
});

// Botón limpiar
 document.getElementById('clearBtn').addEventListener('click', ()=>{
  inputs.forEach(i=>i.value='');
  document.querySelector('input[name="mode"][value="20"]').checked = true;
  customNumerator.value = 10;
  customWrap.hidden = true;
  msg.textContent = '';
  calcBtn.disabled = true;
  results.hidden = true;
  barInitial.style.width = '0%';
  barCurrent.style.width = '0%';
  barInitialText.textContent = '';
  barCurrentText.textContent = '';
  deltaEtdrsEl.textContent = '';
  deltaLogmarEl.textContent = '';
  deficitReductionEl.textContent = '';
  realGainEl.textContent = '';
  initialList.innerHTML = '';
  currentList.innerHTML = '';
  classificationChip.textContent = '—';
  classificationChip.className = 'chip';
  patientLine.textContent = '';
  patientLine.hidden = true;
});

updateButton();
</script>
</body>
</html>
